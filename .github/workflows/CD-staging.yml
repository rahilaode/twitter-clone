# This workflow will run automation deployment to staging servers.
# Triggers : Push or Merge to Main
# Jobs : Deploy to staging
name: Deploy Staging ðŸš€

on:
  push:
    branches: [ "main" ]

jobs:
    deploy-staging:
        name: Deploy to staging server
        runs-on: ubuntu-latest
        environment: staging
        steps:
            - name: Execute deployment command
              uses: appleboy/ssh-action@v1.0.3
              env:
                GIT_URL: ${{ secrets.GIT_URL }}
                MONGO_URI: ${{ secrets.MONGO_URI_STG }}
                NODE_ENV: ${{ vars.NODE_ENV }}"
                
              with:
                host: ${{ secrets.SSH_HOST_STAGING }}
                username: ${{ secrets.SSH_USER_NAME_STAGING }}
                key: ${{ secrets.SSH_PRIVATE_KEY_STAGING }}
                envs: GIT_URL, MONGO_URI, NODE_ENV
                script: |
                  if [[ -d "/home/ubuntu/x-clone" ]]; then 
                    cd /home/ubuntu/x-clone
                    sudo docker compose --file docker-compose.stg.yaml down
                    git pull origin main
                  else
                    git clone $GIT_URL /home/ubuntu/x-clone
                    cd /home/ubuntu/x-clone
                  fi

                  echo "MONGO_URI=$MONGO_URI" > ./app/.env
                  echo "PORT=5000" >> ./app/.env
                  echo "JWT_SECRET=`openssl rand -base64 32`" >> ./app/.env
                  echo "NODE_ENV=$NODE_ENV" >> ./app/.env

                  sudo docker compose --file docker-compose.stg.yaml up --build --detach

            - name: Test Hit Endpoint
              run: |
                sleep 20
                curl ${{ secrets.STG_URL }}

